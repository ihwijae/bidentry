# 국방부 참가신청 자동화 개요

국방부(방위사업청) 참가신청 플로우를 자동화할 때 참고해야 할 전체 절차와 확인 포인트를 정리했습니다. 실제 구현은 `automation-engine/src/core/orchestrator.js` 및 `automation-engine/src/sites/mnd.js`를 중심으로 구성되어 있습니다.

## 1. 기본 구조
- **작업 입력**: `job.site="mnd"`, `job.bidIds`(또는 `bidId`)에 공고번호 목록을 넣어 CLI를 실행합니다. `job.company`, `job.cert`, `job.auth`에 회사/인증서/로그인 정보를 세팅합니다.
- **초기 인증서 처리**: `handleMndCertificate`로 로그인 화면의 공인인증서 모달을 자동 처리하고, 선택한 인증서 정보를 `job.__mndLastCertSelection`에 저장해 이후 참가신청 단계 힌트로 재사용합니다.
- **공고 반복 처리**: `bidQueue = job.bidIds`를 순회하며 공고마다 `goToMndAgreementAndSearch` → `applyMndAgreementAfterSearch`를 호출합니다. 한 공고에서 오류가 나도 나머지 공고는 계속 진행합니다.

## 2. 주요 단계
1. **사이트 접속 및 로그인**
   - 로그인 탭/입력 필드 탐색 (`automation-engine/src/sites/mnd.js:40~300`).
   - ID/PW 입력 후 인증서 로그인 버튼 클릭.
   - 인증서 모달(로그인용) 처리: 매체 선택, 인증서 선택, PIN 입력.
2. **공고 검색 및 상세 이동**
   - 좌측 메뉴 혹은 SBGrid 컨트롤러를 통해 공고 상세 페이지로 이동.
   - 서약서/주의사항 팝업을 감시(`installMndPopupGuards`)하며 닫습니다.
3. **참가신청서 작성/제출** (`applyMndAgreementAfterSearch`)
   - 페이지 전환 감지(`ensureApplyPage`) 후 보증금 면제 선택, 약관 동의 체크.
   - `#btn_wrt`(협정자동신청) 버튼 클릭.
   - **최종 인증서 모달**을 다시 띄워 `handleMndCertificate` 수행. 이전에 선택한 인증서 힌트(`selectionHint`)를 활용해 정확히 동일한 인증서를 재선택.
   - 제출 확인/사후심사 팝업을 닫고, 필요하면 홈으로 복귀.

## 3. 인증서 선택 관련 주의사항
- `docs/mnd-next-session.md`에 기록된 대로, 로그인 단계에서 선택한 인증서를 기억했다가 참가신청 단계에서도 동일한 행을 찾도록 `selectionHint`를 전달합니다.
- `automation-engine/src/sites/nxCertificate.js`는 `dumpTag` 옵션을 받아 인증서 모달 DOM 덤프를 저장합니다. 덤프를 켜려면 `job.options.dumpMndCertDom`을 `true`로 두세요.
- 참가신청 단계에서는 인증서 리스트 렌더링이 늦게 이루어지므로, 모달이 완전히 표시되고 `#select-cert-list`에 `<td>` 행이 채워질 때까지 대기 후 선택하도록 수정되어 있습니다.

## 4. 오류 및 로그 수집
- CLI는 모든 단계를 JSON 이벤트로 표준 출력합니다(`로그.md` 참조). `type: "log"`, `"error"`, `"bid_status"` 이벤트를 활용해 어디에서 실패했는지 추적할 수 있습니다.
- 실패 시 `engine_runs/<timestamp>_*` 파일로 DOM 덤프와 스크린샷을 남기도록 곳곳에 `dumpMndState` / 인증서 덤프가 삽입되어 있습니다. 문제 보고 시 해당 파일명을 함께 기록하면 재현이 쉬워집니다.
- 한 공고에서 에러가 나면 `bidProgressState`에 `status:'error'`로 반영되고, 나머지 공고는 루프를 계속 돕니다. 동일 공고번호를 여러 번 입력하지 않는 한 중복 신청은 발생하지 않습니다.

## 5. UI와의 연동
- Electron UI(`electron-app/renderer/renderer.js`)에서 사용자가 공고번호를 여러 개 입력하면 `job.bidIds` 배열에 그대로 전달됩니다.
- 진행상황 패널(공고 진행상황)에는 각 공고별 상태와 복사 버튼이 표시되며, 자동화 엔진의 `bid_status` 이벤트(`start/done/error`)를 수신해 업데이트합니다.

## 6. 문제 대응 체크리스트
- **로그인 실패**: ID/PW 필드나 인증서 모달 탐색에 실패한 경우 `docs/mnd-bid-search-followup.md`, `mnd-popup-followup.md` 참고.
- **참가신청 인증서 실패**: `Certificate confirm failed:` 로그가 남으면 덤프 파일(`mnd_apply_cert_*`)을 확인해 DOM 구조/선택 행을 재검증합니다.
- **팝업 미처리**: `post_review_popup` 덤프를 확인해 셀렉터를 보강합니다.
- **자격 조건 미충족**: 사이트에서 노출하는 경고 텍스트를 로그에서 확인 후 UI/엔진에 안내.

이 문서를 기반으로 다음 세션에서 추가 수정/인계를 진행하면 됩니다.
