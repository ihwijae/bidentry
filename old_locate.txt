async function locateModal() {
    while (Date.now() - start < timeoutMs) {
      const pages = context ? context.pages() : [page];
      for (const current of pages) {
        const scopes = [current, ...(current.frames?.() || [])];
        for (const scope of scopes) {
          for (const sel of selectors) {
            if (!sel) continue;
            try {
              const handle = await scope.$(sel);
              if (handle) {
                return { certPage: current, scope };
              }
            } catch {}
          }
        }
      }
      await sleep(200);
    }
    return null;
  }

  const located = await locateModal();
  if (!located) {
    log('error', 'Certificate modal not detected within timeout');
    return { ok: false, error: 'Certificate modal not detected' };
  }

  const certPage = located.certPage;
  const scope = located.scope;
  log('info', `Certificate modal located (url=${certPage.url?.() || ''})`);

  const preferSubject = String(cert.subjectMatch || cert.subject || extra?.subject || extra?.company?.name || '').trim();
  const preferIssuer = String(cert.issuerMatch || cert.provider || '').trim();
  const preferSerial = String(cert.serialMatch || cert.serial || '').trim();
  const pinValue = String(cert.pin || cert.password || '').trim();

  
